<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VetRed - Administración</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/frontend/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/frontend/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-paw"></i> VETRED</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active">
                    <i class="fas fa-users"></i>
                    Empleados
                </a>
                <a href="/consultas" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    Consultas
                </a>
                <a href="/clientes" class="nav-item">
                    <i class="fas fa-user-friends"></i>
                    Clientes
                </a>
                <a href="/login" class="nav-item">
                    <i class="fas fa-sign-out-alt"></i>
                    Cerrar Sesión
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="content-header">
                <div>
                    <h1>Empleados</h1>
                    <p id="sede-info">Gestión de Empleados - Sede: <span id="sede-actual">Cargando...</span></p>
                </div>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="admin-nombre">Administrador</h3>
                        <p id="admin-correo">admin@vetclinic.com</p>
                    </div>
                </div>
            </div>

            <!-- Employees Section -->
            <div class="employees-section">
                <div class="section-header">
                    <div class="section-title">
                        <h2>Lista de Empleados</h2>
                        <p>Administre el personal veterinario de la clínica</p>
                    </div>
                   
                    <button class="btn-add" onclick="agregarEmpleado()">
                        <i class="fas fa-plus"></i>
                        Agregar Empleado
                    </button>
                    
                </div>

                <table class="employees-table">
                    <thead>
                        <tr>
                            <th>ID Empleado</th>
                            <th>Nombre</th>
                            <th>Dirección</th>
                            <th>Salario</th>
                            <th>Fecha Contratación</th>
                            <th>Sede</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="empleados-tbody">
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar empleado -->
    <div id="empleadoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h3 id="modalTitle" style="margin-bottom: 20px; color: var(--text-dark); font-size: 1.5rem;">Agregar Empleado</h3>
            <form id="empleadoForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">ID Empleado:</label>
                    <input type="number" id="idEmpleado" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Nombre:</label>
                    <input type="text" id="nombre" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Dirección:</label>
                    <input type="text" id="direccion" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Salario:</label>
                    <input type="number" id="salario" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Fecha de Contratación:</label>
                    <input type="date" id="fechaContratacion" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Sede:</label>
                    <select id="sedeEmpleado" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                        <option value="">Seleccionar sede</option>
                        <option value="1">Quito</option>
                        <option value="2">Guayaquil</option>
                    </select>
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" onclick="cerrarModal()" style="padding: 12px 24px; background: #e2e8f0; color: var(--text-dark); border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Cancelar</button>
                    <button type="submit" style="padding: 12px 24px; background: linear-gradient(45deg, #4fd1c7, #667eea); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Guardar</button>
                </div>
            </form>
        </div>
    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar/editar empleado -->
    <div id="empleadoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h3 id="modalTitle" style="margin-bottom: 20px; color: var(--text-dark); font-size: 1.5rem;">Agregar Empleado</h3>
            <form id="empleadoForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">ID Empleado:</label>
                    <input type="number" id="idEmpleado" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Nombre:</label>
                    <input type="text" id="nombre" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Dirección:</label>
                    <input type="text" id="direccion" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Salario:</label>
                    <input type="number" id="salario" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Fecha de Contratación:</label>
                    <input type="date" id="fechaContratacion" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-dark); font-weight: 600;">Sede:</label>
                    <select id="sedeEmpleado" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                        <option value="">Seleccionar sede</option>
                        <option value="1">Quito</option>
                        <option value="2">Guayaquil</option>
                    </select>
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" onclick="cerrarModal()" style="padding: 12px 24px; background: #e2e8f0; color: var(--text-dark); border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Cancelar</button>
                    <button type="submit" style="padding: 12px 24px; background: linear-gradient(45deg, #4fd1c7, #667eea); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
  const API = "/api/empleados";

  // Al cargar la página, actualizar información del usuario
  window.addEventListener("DOMContentLoaded", function() {
    actualizarInfoUsuario();
    cargarEmpleados();
  });

  function actualizarInfoUsuario() {
    try {
      const userData = localStorage.getItem('user');
      if (userData) {
        const user = JSON.parse(userData);
        
        // Actualizar información en el header
        if (user.nombre) {
          document.getElementById('admin-nombre').textContent = user.nombre;
        }
        if (user.correo) {
          document.getElementById('admin-correo').textContent = user.correo;
        }
        if (user.sede) {
          document.getElementById('sede-actual').textContent = user.sede;
        }
      }
    } catch (e) {
      console.error('Error al cargar información del usuario:', e);
    }
  }

  async function cargarEmpleados() {
    try {
      console.log("Iniciando carga de empleados...");
      
      // Obtener información del usuario del localStorage
      const userData = localStorage.getItem('user');
      let sedeAdmin = 'Quito'; // Por defecto
      
      if (userData) {
        const user = JSON.parse(userData);
        if (user.sede) {
          sedeAdmin = user.sede;
        }
      }
      
      console.log("Sede del administrador:", sedeAdmin);
      
      // Incluir sede_admin como parámetro en la URL
      const url = `${API}?sede_admin=${encodeURIComponent(sedeAdmin)}`;
      const res = await fetch(url);
      
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      
      const lista = await res.json();
      console.log("Empleados cargados para sede", sedeAdmin, ":", lista);
      
      const tbody = document.getElementById("empleados-tbody");
      tbody.innerHTML = "";
      
      lista.forEach(emp => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${emp.idEmpleado}</td>
          <td>${emp.nombre}</td>
          <td>${emp.direccion || "No especificada"}</td>
          <td>$${emp.salario?.toFixed(2) || "0.00"}</td>
          <td>${new Date(emp.fechaContratacion).toLocaleDateString()}</td>
          <td>${emp.idClinica == 1 ? 'Quito' : 'Guayaquil'}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-action btn-edit" onclick="editarEmpleado(${emp.idEmpleado},${emp.idClinica})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-action btn-delete" onclick="eliminarEmpleado(${emp.idEmpleado},${emp.idClinica})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error("Error cargando empleados:", error);
      const tbody = document.getElementById("empleados-tbody");
      tbody.innerHTML = `<tr><td colspan="7">Error cargando empleados: ${error.message}</td></tr>`;
    }
  }

  // 2) Eliminar
  async function eliminarEmpleado(idEmp, idClin) {
    if (!confirm("Eliminar este empleado?")) return;
    try {
      const response = await fetch(`${API}/${idEmp}/${idClin}`, { method: "DELETE" });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      cargarEmpleados();
    } catch (error) {
      console.error("Error eliminando empleado:", error);
      alert("Error eliminando empleado: " + error.message);
    }
  }

  // 3) Abrir modal + lógica para crear/editar
  let editMode = false;
  let originalIdEmpleado = null;
  let originalIdClinica = null;

  function agregarEmpleado() {
    editMode = false;
    originalIdEmpleado = null;
    originalIdClinica = null;
    document.getElementById("modalTitle").textContent = "Agregar Empleado";
    document.getElementById("empleadoModal").style.display = "flex";
    document.getElementById("empleadoForm").reset();
    
    // Habilitar campo ID en modo agregar
    document.getElementById("idEmpleado").disabled = false;
    
    // Establecer sede por defecto según el admin
    const userData = localStorage.getItem('user');
    if (userData) {
      const user = JSON.parse(userData);
      if (user.sede === "Guayaquil") {
        document.getElementById("sedeEmpleado").value = "2";
      } else {
        document.getElementById("sedeEmpleado").value = "1";
      }
    }
  }

  async function editarEmpleado(idEmp, idClin) {
    editMode = true;
    originalIdEmpleado = idEmp;
    originalIdClinica = idClin;
    
    // Buscar los datos del empleado en la tabla actual
    const filas = document.querySelectorAll("#empleados-tbody tr");
    let empleadoData = null;
    
    filas.forEach(fila => {
      const celdas = fila.querySelectorAll("td");
      if (celdas.length > 0) {
        // Los datos están en el orden: idEmpleado, nombre, direccion, salario, fechaContratacion, sede
        const btnEdit = fila.querySelector('button[onclick*="editarEmpleado"]');
        if (btnEdit && btnEdit.onclick.toString().includes(`editarEmpleado(${idEmp},${idClin})`)) {
          empleadoData = {
            idEmpleado: parseInt(celdas[0].textContent),
            nombre: celdas[1].textContent,
            direccion: celdas[2].textContent === 'No especificada' ? '' : celdas[2].textContent,
            salario: parseFloat(celdas[3].textContent.replace('$', '')) || 0,
            fechaContratacion: celdas[4].textContent,
            idClinica: idClin
          };
        }
      }
    });
    
    if (empleadoData) {
      document.getElementById("modalTitle").textContent = "Editar Empleado";
      document.getElementById("idEmpleado").value = empleadoData.idEmpleado;
      document.getElementById("nombre").value = empleadoData.nombre;
      document.getElementById("direccion").value = empleadoData.direccion;
      document.getElementById("salario").value = empleadoData.salario;
      document.getElementById("sedeEmpleado").value = empleadoData.idClinica;
      
      // Convertir fecha al formato YYYY-MM-DD
      if (empleadoData.fechaContratacion) {
        const fecha = new Date(empleadoData.fechaContratacion);
        if (!isNaN(fecha.getTime())) {
          document.getElementById("fechaContratacion").value = fecha.toISOString().split('T')[0];
        }
      }
      
      // Deshabilitar campo ID en modo editar
      document.getElementById("idEmpleado").disabled = true;
      
      document.getElementById("empleadoModal").style.display = "flex";
    }
  }

  function cerrarModal() {
    document.getElementById("empleadoModal").style.display = "none";
    editMode = false;
    originalIdEmpleado = null;
    originalIdClinica = null;
  }

  // 4) Manejar envío del formulario
  document.getElementById("empleadoForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    
    try {
      const formData = {
        idEmpleado: parseInt(document.getElementById("idEmpleado").value),
        nombre: document.getElementById("nombre").value,
        direccion: document.getElementById("direccion").value || null,
        salario: parseFloat(document.getElementById("salario").value) || 0,
        fechaContratacion: document.getElementById("fechaContratacion").value || null,
        idClinica: parseInt(document.getElementById("sedeEmpleado").value)
      };
      
      console.log("Enviando empleado:", formData);
      
      let response;
      if (editMode) {
        // Modo editar - usar PUT
        response = await fetch(API, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(formData)
        });
      } else {
        // Modo agregar - usar POST
        response = await fetch(API, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(formData)
        });
      }
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`HTTP error! status: ${response.status}, details: ${JSON.stringify(errorData)}`);
      }
      
      cerrarModal();
      cargarEmpleados();
      alert(editMode ? "Empleado actualizado exitosamente" : "Empleado agregado exitosamente");
    } catch (error) {
      console.error("Error guardando empleado:", error);
      alert("Error guardando empleado: " + error.message);
    }
  });
</script>
</body>
</html>
